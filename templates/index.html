<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>SENAT - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background: #0e1621;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #login-container, #chat-container {
            background: #17212b;
            color: white;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        #login-container {
            max-width: 500px;
            max-height: 750px;
            border-radius: 20px;
            padding: 24px;
            margin: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .senator-icon {
            background: #2b5278;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        
        h1 {
            text-align: center;
            font-size: 32px;
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            background: #242f3d;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        .tab-btn.active {
            background: #2b5278;
        }
        
        .form {
            display: none;
        }
        
        .form.active {
            display: block;
        }
        
        .remember-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            color: #708499;
        }
        
        input, button {
            width: 100%;
            padding: 16px;
            margin: 8px 0;
            background: #242f3d;
            border: 1px solid #0e1621;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        button {
            background: #2b5278;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #1e3c58;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 16px;
        }
        
        .success-message {
            color: #4CAF50;
            text-align: center;
            margin-top: 16px;
        }
        
        .hint {
            color: #708499;
            font-size: 12px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        #chat-container {
            flex-direction: row;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .left-panel {
            width: 350px;
            background: #17212b;
            border-right: 1px solid #242f3d;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            position: relative;
            flex-shrink: 0;
            height: 100vh;
            transition: transform 0.3s ease;
        }
        
        .left-panel.open {
            transform: translateX(0);
        }
        
        .profile-header {
            padding: 16px;
            border-bottom: 1px solid #242f3d;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .profile-avatar {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            background: #2b5278;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 20px;
        }
        
        .profile-avatar:hover .avatar-overlay {
            opacity: 1;
        }
        
        .profile-info {
            flex: 1;
            overflow: hidden;
        }
        
        .profile-name {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .profile-username {
            font-size: 13px;
            color: #708499;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .admin-badge {
            background: #ffd700;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .main-tabs {
            display: flex;
            padding: 8px;
            gap: 8px;
            border-bottom: 1px solid #242f3d;
        }
        
        .main-tab {
            flex: 1;
            padding: 10px;
            background: #242f3d;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            text-align: center;
            position: relative;
            transition: all 0.2s;
        }
        
        .main-tab:hover {
            background: #2b5278;
        }
        
        .main-tab.active {
            background: #2b5278;
            font-weight: 600;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .tab-content {
            flex: 1;
            overflow-y: auto;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .search-box {
            padding: 8px;
            border-bottom: 1px solid #242f3d;
            position: relative;
        }
        
        .search-box input {
            padding: 10px;
            margin: 0;
            font-size: 14px;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #242f3d;
            border-radius: 0 0 12px 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 200;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .section-title {
            padding: 12px 12px 4px;
            color: #708499;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            cursor: pointer;
            border-radius: 0;
            position: relative;
            transition: background 0.2s;
        }
        
        .contact-item:hover {
            background: #242f3d;
        }
        
        .contact-item.active {
            background: #2b5278;
        }
        
        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #2b5278;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .contact-info {
            flex: 1;
            overflow: hidden;
            min-width: 0;
        }
        
        .contact-name {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-username {
            font-size: 12px;
            color: #708499;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .contact-lastseen {
            font-size: 11px;
            color: #708499;
            margin-top: 2px;
        }
        
        .contact-menu {
            position: absolute;
            right: 8px;
            background: #17212b;
            border: 1px solid #242f3d;
            border-radius: 8px;
            padding: 4px;
            display: none;
            z-index: 10;
        }
        
        .contact-item:hover .contact-menu {
            display: block;
        }
        
        .contact-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .contact-menu-item:hover {
            background: #2b5278;
        }
        
        .request-badge {
            background: #ffd700;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .search-result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-bottom: 1px solid #17212b;
        }
        
        .add-friend-btn {
            padding: 6px 12px;
            background: #2b5278;
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            margin-left: auto;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .add-friend-btn:hover {
            background: #1e3c58;
        }
        
        .friend-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            margin-left: 4px;
        }
        
        .accept-btn {
            background: #4CAF50;
        }
        
        .accept-btn:hover {
            background: #45a049;
        }
        
        .reject-btn {
            background: #f44336;
        }
        
        .reject-btn:hover {
            background: #da190b;
        }
        
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0e1621;
            min-width: 0;
            position: relative;
        }
        
        .chat-header {
            padding: 12px 16px;
            background: #17212b;
            border-bottom: 1px solid #242f3d;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .menu-toggle {
            display: none;
            font-size: 24px;
            cursor: pointer;
        }
        
        .chat-info {
            flex: 1;
            overflow: hidden;
        }
        
        .chat-title {
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chat-title .admin-badge {
            font-size: 10px;
            padding: 2px 6px;
        }
        
        .chat-subtitle {
            font-size: 13px;
            color: #708499;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-actions {
            display: flex;
            gap: 8px;
        }
        
        .chat-action-btn {
            background: none;
            border: none;
            color: #708499;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .chat-action-btn:hover {
            background: #242f3d;
            color: white;
        }
        
        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 12px;
            background: #242f3d;
            color: white;
            align-self: flex-start;
            word-wrap: break-word;
            position: relative;
            font-size: 14px;
            margin: 2px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .message:hover {
            opacity: 0.9;
        }
        
        .message.own {
            background: #2b5278;
            align-self: flex-end;
        }
        
        .message-header {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }
        
        .message-displayname {
            font-size: 13px;
            font-weight: 600;
            color: #708499;
            cursor: pointer;
        }
        
        .message-displayname:hover {
            text-decoration: underline;
        }
        
        .message-username {
            font-size: 11px;
            color: #5a6a7a;
        }
        
        .message.own .message-displayname {
            color: rgba(255,255,255,0.9);
        }
        
        .message.own .message-username {
            color: rgba(255,255,255,0.6);
        }
        
        .message-time {
            font-size: 10px;
            color: rgba(255,255,255,0.5);
            margin-left: auto;
        }
        
        .message-edited {
            font-size: 10px;
            color: rgba(255,255,255,0.4);
            margin-left: 4px;
            font-style: italic;
        }
        
        .message-media {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 4px;
        }
        
        .system-message {
            text-align: center;
            color: #708499;
            font-size: 12px;
            margin: 8px 0;
            font-style: italic;
        }
        
        .input-area {
            padding: 12px 16px;
            background: #17212b;
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
        }
        
        .input-area input {
            flex: 1;
            padding: 12px 16px;
            margin: 0;
            border-radius: 24px;
            font-size: 14px;
        }
        
        .input-area button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            padding: 0;
            margin: 0;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .attach-btn {
            background: none !important;
            color: #708499 !important;
            font-size: 22px !important;
        }
        
        .attach-btn:hover {
            background: #242f3d !important;
            color: white !important;
        }
        
        .file-preview {
            position: absolute;
            bottom: 80px;
            left: 16px;
            right: 16px;
            background: #242f3d;
            border-radius: 12px;
            padding: 12px;
            display: none;
            align-items: center;
            gap: 12px;
            border: 1px solid #2b5278;
            z-index: 50;
        }
        
        .file-preview img {
            max-width: 60px;
            max-height: 60px;
            border-radius: 8px;
        }
        
        .close-preview {
            margin-left: auto;
            cursor: pointer;
            font-size: 20px;
            color: #708499;
        }
        
        .message-menu {
            position: fixed;
            background: #17212b;
            border: 1px solid #242f3d;
            border-radius: 12px;
            padding: 4px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .message-menu-item {
            padding: 12px 24px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .message-menu-item:hover {
            background: #2b5278;
        }
        
        .close-menu-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        
        .close-menu-btn:hover {
            transform: scale(1.1);
        }
        
        .left-panel.open + .close-menu-btn {
            display: flex;
        }
        
        .search-messages {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 300px;
            background: #17212b;
            border-radius: 12px;
            padding: 12px;
            display: none;
            z-index: 100;
            border: 1px solid #242f3d;
        }
        
        .group-menu {
            position: absolute;
            right: 8px;
            background: #17212b;
            border: 1px solid #242f3d;
            border-radius: 8px;
            padding: 4px;
            display: none;
            z-index: 10;
        }
        
        .group-item:hover .group-menu {
            display: block;
        }
        
        .group-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
        }
        
        .group-menu-item:hover {
            background: #2b5278;
        }
        
        @media (max-width: 768px) {
            #chat-container {
                flex-direction: column;
            }
            
            .left-panel {
                width: 100%;
                height: 100vh;
                position: absolute;
                left: 0;
                transform: translateX(-100%);
                z-index: 1000;
                box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .right-panel {
                width: 100%;
                height: 100vh;
            }
            
            .message {
                max-width: 85%;
            }
            
            .close-menu-btn {
                display: none !important;
            }
            
            .left-panel.open + .close-menu-btn {
                display: flex !important;
            }
        }
    </style>
</head>
<body>



    <!-- –í–•–û–î/–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
    <div id="login-container">
        <div class="senator-icon">S</div>
        <h1>SENAT</h1>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="switchTab('login')">–í—Ö–æ–¥</button>
            <button class="tab-btn" onclick="switchTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div id="login-form" class="form active">
            <input type="text" id="login-username" placeholder="username (–±–µ–∑ @)" autocomplete="off">
            <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off">
            <div class="remember-checkbox">
                <input type="checkbox" id="remember-me" style="width: auto; margin: 0;">
                <label for="remember-me">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
            </div>
            <button onclick="login()">üöÄ –í–æ–π—Ç–∏</button>
        </div>

        <div id="register-form" class="form">
            <input type="text" id="reg-username" placeholder="username (–±–µ–∑ @)" autocomplete="off">
            <div class="hint">–ü—Ä–∏–¥—É–º–∞–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π username, –æ–Ω –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤—Ö–æ–¥–∞</div>
            <input type="text" id="reg-displayname" placeholder="–¢–≤–æ—ë –∏–º—è (–Ω–∏–∫)" autocomplete="off">
            <div class="hint">–≠—Ç–æ –∏–º—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="off">
            <input type="password" id="reg-password2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="off">
            <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0; flex-wrap: wrap;">
                <span style="font-size: 30px; cursor: pointer;" onclick="selectAvatar('üë§')">üë§</span>
                <span style="font-size: 30px; cursor: pointer;" onclick="selectAvatar('üê±')">üê±</span>
                <span style="font-size: 30px; cursor: pointer;" onclick="selectAvatar('üê∂')">üê∂</span>
                <span style="font-size: 30px; cursor: pointer;" onclick="selectAvatar('ü§ñ')">ü§ñ</span>
                <span style="font-size: 30px; cursor: pointer;" onclick="selectAvatar('üëΩ')">üëΩ</span>
                <span style="font-size: 30px; cursor: pointer;" onclick="selectAvatar('üì∑')" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ—ë —Ñ–æ—Ç–æ">üì∑</span>
            </div>
            <button onclick="register()">üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>

        <div id="login-error" class="error-message"></div>
        <div id="register-success" class="success-message"></div>
    </div>

    <!-- –û–°–ù–û–í–ù–û–ô –ß–ê–¢ -->
    <div id="chat-container" style="display: none;">
        <div class="left-panel" id="left-panel">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar" onclick="showAvatarMenu()">
                    <span id="profile-avatar-text">üë§</span>
                    <div class="avatar-overlay">üì∑</div>
                </div>
                <div class="profile-info">
                    <div class="profile-name" id="profile-name">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="profile-username" id="profile-username">@–∑–∞–≥—Ä—É–∑–∫–∞</div>
                </div>
                <span class="admin-badge" id="admin-badge" style="display: none;">–ê–î–ú–ò–ù</span>
            </div>
            
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchMainTab('global')">üåê –ì–ª–æ–±–∞–ª—å–Ω—ã–π</button>
                <button class="main-tab" onclick="switchMainTab('contacts')" id="contacts-tab-btn">
                    üë• –ö–æ–Ω—Ç–∞–∫—Ç—ã
                    <span class="notification-badge" id="contact-notification" style="display: none;">!</span>
                </button>
                <button class="main-tab" onclick="switchMainTab('groups')">üë• –ì—Ä—É–ø–ø—ã</button>
            </div>
            
            <div id="global-tab" class="tab-content active">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ª—é–¥–µ–π...">
                    <div class="search-results" id="search-results"></div>
                </div>
                
                <div class="section-title">–í–°–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò</div>
                <div class="contacts-list" id="all-users-list"></div>
            </div>
            
            <div id="contacts-tab" class="tab-content">
                <div class="section-title">–ó–ê–Ø–í–ö–ò –í –î–†–£–ó–¨–Ø</div>
                <div class="contacts-list" id="pending-requests"></div>
                
                <div class="section-title">–ú–û–ò –ö–û–ù–¢–ê–ö–¢–´</div>
                <div class="contacts-list" id="contacts-list"></div>
            </div>

            <div id="groups-tab" class="tab-content">
                <div style="padding: 12px;">
                    <button class="add-friend-btn" onclick="createGroup()" style="width: 100%; padding: 12px;">‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                </div>
                <div class="section-title">–ú–û–ò –ì–†–£–ü–ü–´</div>
                <div class="contacts-list" id="groups-list"></div>
            </div>
        </div>
        
        <div class="right-panel">
            <div class="chat-header">
                <span class="menu-toggle" onclick="toggleMenu()">‚ò∞</span>
                <div class="chat-info">
                    <div class="chat-title" id="current-chat">
                        –û–±—â–∏–π —á–∞—Ç
                        <span class="admin-badge" id="chat-admin-badge" style="display: none;">–ê–î–ú–ò–ù</span>
                    </div>
                    <div class="chat-subtitle" id="chat-subtitle"></div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="showSearchMessages()" title="–ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º">üîç</button>
                    <button class="chat-action-btn" onclick="showAttachMenu()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">üìé</button>
                    <button class="chat-action-btn" onclick="clearCurrentChat()" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">üóëÔ∏è</button>
                </div>
            </div>
            
            <div class="messages-area" id="messages" onclick="hideMessageMenu()"></div>
            
            <div class="input-area">
                <button class="chat-action-btn attach-btn" onclick="showAttachMenu()">üìé</button>
                <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="sendMessage()">‚û§</button>
                
                <div class="file-preview" id="file-preview">
                    <span id="file-preview-content"></span>
                    <span class="close-preview" onclick="clearFilePreview()">‚úï</span>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ -->
    <div class="close-menu-btn" onclick="closeMobileMenu()">‚úï</div>

    <!-- –ú–µ–Ω—é —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="message-menu" id="message-menu">
        <div class="message-menu-item" onclick="copyMessage()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="message-menu-item" id="edit-message-btn" onclick="editMessage()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</div>
    </div>

    <!-- –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º -->
    <div class="search-messages" id="search-messages">
        <input type="text" id="message-search-input" placeholder="–ü–æ–∏—Å–∫...">
        <div id="message-search-results" style="max-height: 200px; overflow-y: auto;"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–æ–π -->
    <div id="group-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: #17212b; border-radius: 12px; padding: 20px; width: 350px; max-height: 80vh; overflow-y: auto;">
            <h3 id="group-modal-title" style="margin-bottom: 15px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–æ–π</h3>
            <div id="group-modal-content"></div>
            <button onclick="closeGroupModal()" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentRoom = 'general';
        let currentChatType = 'global';
        let currentPrivateUser = '';
        let currentGroupId = '';
        let username = '';
        let displayName = '';
        let selectedAvatar = 'üë§';
        let friends = [];
        let pendingRequests = [];
        let allUsers = [];
        let blockedUsers = [];
        let groups = [];
        let selectedMessageId = null;
        let selectedMessageText = '';
        let selectedMessageTime = null;
        let fileToSend = null;
        let notificationCount = 0;
        let currentGroupForAdd = null;

        socket.emit('auto_login');

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.form').forEach(form => form.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('login-form').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('register-form').classList.add('active');
            }
            clearMessages();
        }

        function switchMainTab(tab) {
            document.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'global') {
                document.querySelectorAll('.main-tab')[0].classList.add('active');
                document.getElementById('global-tab').classList.add('active');
                joinGlobalChat();
            } else if (tab === 'contacts') {
                document.querySelectorAll('.main-tab')[1].classList.add('active');
                document.getElementById('contacts-tab').classList.add('active');
                document.getElementById('contact-notification').style.display = 'none';
                notificationCount = 0;
            } else if (tab === 'groups') {
                document.querySelectorAll('.main-tab')[2].classList.add('active');
                document.getElementById('groups-tab').classList.add('active');
                socket.emit('get_groups');
            }
        }

        function joinGlobalChat() {
            if (currentRoom !== 'general') {
                socket.emit('join_room', { room: 'general', old_room: currentRoom });
                currentRoom = 'general';
                currentChatType = 'global';
                document.getElementById('current-chat').textContent = '–û–±—â–∏–π —á–∞—Ç';
                document.getElementById('chat-subtitle').textContent = '';
                if (username === 'SENATOR') {
                    document.getElementById('chat-admin-badge').style.display = 'inline-block';
                } else {
                    document.getElementById('chat-admin-badge').style.display = 'none';
                }
            }
        }

        function openPrivateChat(user) {
            const roomId = `private_${username}_${user}`;
            if (currentRoom !== roomId) {
                socket.emit('join_room', { room: roomId, old_room: currentRoom });
                currentRoom = roomId;
                currentChatType = 'private';
                currentPrivateUser = user;
                document.getElementById('current-chat').textContent = user;
                document.getElementById('chat-subtitle').textContent = '–õ–∏—á–Ω—ã–π —á–∞—Ç';
                document.getElementById('chat-admin-badge').style.display = 'none';
                
                if (window.innerWidth <= 768) {
                    toggleMenu();
                }
            }
        }

        function openGroupChat(groupId, groupName) {
            if (currentRoom !== groupId) {
                socket.emit('join_room', { room: groupId, old_room: currentRoom });
                currentRoom = groupId;
                currentChatType = 'group';
                currentGroupId = groupId;
                document.getElementById('current-chat').textContent = groupName;
                document.getElementById('chat-subtitle').textContent = '–ì—Ä—É–ø–ø–∞';
                document.getElementById('chat-admin-badge').style.display = 'none';
                
                if (window.innerWidth <= 768) {
                    toggleMenu();
                }
            }
        }

        function clearMessages() {
            document.getElementById('login-error').textContent = '';
            document.getElementById('register-success').textContent = '';
        }

        function selectAvatar(avatar) {
            if (avatar === 'üì∑') {
                uploadCustomAvatar();
            } else {
                selectedAvatar = avatar;
            }
        }

        function uploadCustomAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå –§–∞–π–ª –±–æ–ª—å—à–µ 5MB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    selectedAvatar = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function register() {
            const username = document.getElementById('reg-username').value.trim();
            const displayName = document.getElementById('reg-displayname').value.trim() || username;
            const password = document.getElementById('reg-password').value.trim();
            const password2 = document.getElementById('reg-password2').value.trim();

            if (!username || !password) {
                document.getElementById('login-error').textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!';
                return;
            }
            if (password !== password2) {
                document.getElementById('login-error').textContent = '‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!';
                return;
            }

            socket.emit('register', { username, password, display_name: displayName, avatar: selectedAvatar });
        }

        function login() {
            username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const remember = document.getElementById('remember-me').checked;

            if (!username || !password) {
                document.getElementById('login-error').textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!';
                return;
            }

            socket.emit('login', { username, password, remember });
        }

        socket.on('register_success', (data) => {
            document.getElementById('register-success').textContent = '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ.';
            switchTab('login');
            document.getElementById('login-username').value = data.username;
        });

        socket.on('register_error', (data) => {
            document.getElementById('login-error').textContent = data.msg;
        });




        socket.on('login_success', (data) => {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('chat-container').style.display = 'flex';
            
            username = data.username;
            displayName = data.display_name;
            friends = data.friends || [];
            pendingRequests = data.pending_in || [];
            blockedUsers = data.blocked || [];
            
            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-username').textContent = `@${username}`;
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–∏
            const avatarElement = document.getElementById('profile-avatar');
            const avatarText = document.getElementById('profile-avatar-text');
            
            if (data.avatar && data.avatar.startsWith('data:image')) {
                avatarText.style.display = 'none';
                avatarElement.innerHTML = `<img src="${data.avatar}"><div class="avatar-overlay">üì∑</div>`;
            } else {
                avatarText.style.display = 'flex';
                avatarText.textContent = data.avatar || 'üë§';
                avatarElement.innerHTML = `<span id="profile-avatar-text">${data.avatar || 'üë§'}</span><div class="avatar-overlay">üì∑</div>`;
            }
            
            if (data.is_admin) {
                document.getElementById('admin-badge').style.display = 'inline-block';
            } else {
                document.getElementById('admin-badge').style.display = 'none';
            }
            
            if (username === 'SENATOR') {
                document.getElementById('chat-admin-badge').style.display = 'inline-block';
            }
            
            updateContactsList();
            addSystemMessage(`‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${displayName} (@${username})!`);
        });

        socket.on('login_error', (data) => {
            document.getElementById('login-error').textContent = data.msg;
        });

        socket.on('banned', (data) => {
            alert(`‚ùå –í–∞—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è.\n–ü—Ä–∏—á–∏–Ω–∞: ${data.reason}\n–°–≤—è–∑—å: @SENATOR_DANIIL`);
            document.getElementById('login-container').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'none';
        });

        // ============ –ê–í–ê–¢–ê–†–ö–ò ============
        socket.on('avatar_updated', (data) => {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            allUsers = allUsers.map(user => {
                if (user.username === data.username) {
                    user.avatar = data.avatar;
                }
                return user;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateAllUsersList();
            
            // –ï—Å–ª–∏ —ç—Ç–æ –∞–≤–∞—Ç–∞—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (data.username === username) {
                const avatarElement = document.getElementById('profile-avatar');
                const avatarText = document.getElementById('profile-avatar-text');
                
                if (data.avatar.startsWith('data:image')) {
                    avatarText.style.display = 'none';
                    avatarElement.innerHTML = `<img src="${data.avatar}"><div class="avatar-overlay">üì∑</div>`;
                }
            }
        });

        socket.on('profile_updated', (data) => {
            if (data.username === username) {
                document.getElementById('profile-name').textContent = data.display_name;
                
                const avatarElement = document.getElementById('profile-avatar');
                const avatarText = document.getElementById('profile-avatar-text');
                
                if (data.avatar && data.avatar.startsWith('data:image')) {
                    avatarText.style.display = 'none';
                    avatarElement.innerHTML = `<img src="${data.avatar}"><div class="avatar-overlay">üì∑</div>`;
                } else {
                    avatarText.style.display = 'flex';
                    avatarText.textContent = data.avatar || 'üë§';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ –≤—Å–µ—Ö —Å–ø–∏—Å–∫–∞—Ö
            allUsers = allUsers.map(user => {
                if (user.username === data.username) {
                    user.display_name = data.display_name;
                    user.avatar = data.avatar;
                }
                return user;
            });
            updateAllUsersList();
        });

        // ============ –ü–û–ò–°–ö ============
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 1) {
                document.getElementById('search-results').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                socket.emit('search_users', { query });
            }, 300);
        });

        socket.on('search_results', (results) => {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            
            if (results.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            results.forEach(user => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                
                let buttonHtml = '';
                if (!user.is_friend && !user.pending_out && !user.is_blocked) {
                    buttonHtml = `<button class="add-friend-btn" onclick="sendFriendRequest('${user.username}')">‚ûï –í –¥—Ä—É–∑—å—è</button>`;
                } else if (user.pending_out) {
                    buttonHtml = `<span style="color: #708499;">‚è≥ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>`;
                } else if (user.pending_in) {
                    buttonHtml = `<span style="color: #ffd700;">üì® –í—Ö–æ–¥—è—â–∞—è</span>`;
                } else if (user.is_friend) {
                    buttonHtml = `<span style="color: #4CAF50;">‚úì –î—Ä—É–≥</span>`;
                }
                
                let avatarHtml = '';
                if (user.avatar && user.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${user.avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">`;
                } else {
                    avatarHtml = `<span style="font-size: 24px;">${user.avatar || 'üë§'}</span>`;
                }
                
                div.innerHTML = `
                    <div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                        ${avatarHtml}
                    </div>
                    <div style="flex: 1; overflow: hidden;">
                        <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${user.display_name}</div>
                        <div style="font-size: 11px; color: #708499;">@${user.username}</div>
                    </div>
                    ${buttonHtml}
                `;
                resultsDiv.appendChild(div);
            });
            
            resultsDiv.style.display = 'block';
        });

        socket.on('all_users', (users) => {
            allUsers = users;
            updateAllUsersList();
        });

        function updateAllUsersList() {
            const listDiv = document.getElementById('all-users-list');
            listDiv.innerHTML = '';
            
            allUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                
                const isFriend = friends.includes(user.username);
                const isPending = user.pending_out;
                const isBlocked = blockedUsers.includes(user.username);
                
                let actionButton = '';
                if (!isFriend && !isPending && !isBlocked) {
                    actionButton = `<button class="add-friend-btn" onclick="sendFriendRequest('${user.username}')">‚ûï</button>`;
                } else if (isPending) {
                    actionButton = `<span style="color: #708499;">‚è≥</span>`;
                } else if (isFriend) {
                    actionButton = `<span style="color: #4CAF50;">‚úì</span>`;
                }
                
                let avatarHtml = '';
                if (user.avatar && user.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${user.avatar}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">`;
                } else {
                    avatarHtml = `<span>${user.avatar || 'üë§'}</span>`;
                }
                
                div.innerHTML = `
                    <div class="contact-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="contact-info" onclick="openPrivateChat('${user.username}')">
                        <div class="contact-name">${user.display_name || user.username}</div>
                        <div class="contact-username">@${user.username}</div>
                        <div class="contact-lastseen">${user.last_seen || ''}</div>
                    </div>
                    <div class="contact-menu">
                        <div class="contact-menu-item" onclick="openPrivateChat('${user.username}')">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</div>
                        ${!isBlocked ? `<div class="contact-menu-item" onclick="blockUser('${user.username}')">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>` : 
                                        `<div class="contact-menu-item" onclick="unblockUser('${user.username}')">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</div>`}
                        ${username === 'SENATOR' ? `<div class="contact-menu-item" onclick="banUser('${user.username}')">üî® –ó–∞–±–∞–Ω–∏—Ç—å</div>` : ''}
                        ${isFriend ? `<div class="contact-menu-item" onclick="showAddToGroupModal('${user.username}')">üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</div>` : ''}
                    </div>
                    ${actionButton}
                `;
                listDiv.appendChild(div);
            });
        }

        // ============ –ó–ê–Ø–í–ö–ò –í –î–†–£–ó–¨–Ø ============
        function sendFriendRequest(to) {
            socket.emit('send_friend_request', { to });
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('search-input').value = '';
        }

        function acceptRequest(from) {
            socket.emit('accept_friend_request', { from });
        }

        function rejectRequest(from) {
            socket.emit('reject_friend_request', { from });
        }

        socket.on('friend_request_sent', (data) => {
            addSystemMessage(`‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ @${data.to}`);
        });

        socket.on('friend_request_received', (data) => {
            pendingRequests.push(data.from);
            updateContactsList();
            notificationCount++;
            document.getElementById('contact-notification').style.display = 'flex';
            document.getElementById('contact-notification').textContent = notificationCount;
            addSystemMessage(`üì® ${data.display_name} (@${data.from}) —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è`);
        });

        socket.on('friend_request_accepted', (data) => {
            friends.push(data.username);
            if (pendingRequests.includes(data.username)) {
                pendingRequests = pendingRequests.filter(u => u !== data.username);
            }
            updateContactsList();
            addSystemMessage(`üéâ @${data.username} —Ç–µ–ø–µ—Ä—å –≤ –¥—Ä—É–∑—å—è—Ö!`);
        });

        socket.on('friend_request_rejected', (data) => {
            if (pendingRequests.includes(data.username)) {
                pendingRequests = pendingRequests.filter(u => u !== data.username);
            }
            updateContactsList();
        });

        // ============ –ì–†–£–ü–ü–´ ============
        function createGroup() {
            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:', `–ì—Ä—É–ø–ø–∞ @${username}`);
            if (name) {
                socket.emit('create_group', { name });
            }
        }

        socket.on('group_created', (data) => {
            socket.emit('get_groups');
            addSystemMessage(`‚úÖ –ì—Ä—É–ø–ø–∞ "${data.name}" —Å–æ–∑–¥–∞–Ω–∞`);
        });

        socket.on('groups_list', (groupsList) => {
            groups = groupsList;
            const groupsDiv = document.getElementById('groups-list');
            groupsDiv.innerHTML = '';
            
            groups.forEach(group => {
                const div = document.createElement('div');
                div.className = 'contact-item group-item';
                
                let avatarHtml = '';
                if (group.avatar && group.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${group.avatar}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">`;
                } else {
                    avatarHtml = `<span>${group.avatar || 'üë•'}</span>`;
                }
                
                const isAdmin = group.admins.includes(username) || group.creator === username;
                
                div.innerHTML = `
                    <div class="contact-avatar" onclick="openGroupChat('${group.id}', '${group.name}')">
                        ${avatarHtml}
                    </div>
                    <div class="contact-info" onclick="openGroupChat('${group.id}', '${group.name}')">
                        <div class="contact-name">${group.name}</div>
                        <div class="contact-username">${group.members.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    ${isAdmin ? `
                        <div class="group-menu">
                            <div class="group-menu-item" onclick="editGroup('${group.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                            <div class="group-menu-item" onclick="manageGroupMembers('${group.id}')">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                            ${group.creator === username ? '<div class="group-menu-item" onclick="deleteGroup(\'' + group.id + '\')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</div>' : ''}
                        </div>
                    ` : ''}
                `;
                groupsDiv.appendChild(div);
            });
        });

        function editGroup(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            const modal = document.getElementById('group-modal');
            const content = document.getElementById('group-modal-content');
            
            content.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</label>
                    <input type="text" id="edit-group-name" value="${group.name}" style="margin-top: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label>–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã:</label>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <span style="font-size: 30px; cursor: pointer;" onclick="selectGroupAvatar('üë•')">üë•</span>
                        <span style="font-size: 30px; cursor: pointer;" onclick="selectGroupAvatar('üë§')">üë§</span>
                        <span style="font-size: 30px; cursor: pointer;" onclick="selectGroupAvatar('üê±')">üê±</span>
                        <span style="font-size: 30px; cursor: pointer;" onclick="selectGroupAvatar('üê∂')">üê∂</span>
                        <span style="font-size: 30px; cursor: pointer;" onclick="selectGroupAvatar('ü§ñ')">ü§ñ</span>
                        <span style="font-size: 30px; cursor: pointer;" onclick="selectGroupAvatar('üëΩ')">üëΩ</span>
                        <span style="font-size: 30px; cursor: pointer;" onclick="uploadGroupAvatar()">üì∑</span>
                    </div>
                </div>
                <button onclick="saveGroupChanges('${groupId}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;
            
            modal.style.display = 'flex';
        }

        function selectGroupAvatar(avatar) {
            document.getElementById('group-avatar-selected').value = avatar;
        }

        function uploadGroupAvatar() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    selectGroupAvatar(event.target.result);
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function saveGroupChanges(groupId) {
            const newName = document.getElementById('edit-group-name')?.value;
            socket.emit('update_group', { group_id: groupId, name: newName });
            closeGroupModal();
        }

        function manageGroupMembers(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;
            
            const modal = document.getElementById('group-modal');
            const content = document.getElementById('group-modal-content');
            
            let membersHtml = '';
            group.members.forEach(member => {
                const canRemove = member !== group.creator && (group.admins.includes(username) || group.creator === username);
                membersHtml += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #242f3d;">
                        <span>@${member} ${group.admins.includes(member) ? 'üëë' : ''}</span>
                        ${canRemove ? `<button onclick="removeFromGroup('${groupId}', '${member}')" style="width: auto; padding: 4px 8px;">‚ùå</button>` : ''}
                    </div>
                `;
            });
            
            content.innerHTML = `
                <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≥—Ä—É–ø–ø—ã</h4>
                <div style="max-height: 200px; overflow-y: auto; margin-bottom: 15px;">
                    ${membersHtml}
                </div>
                <h4>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h4>
                <select id="add-member-select" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç</option>
                    ${friends.map(f => `<option value="${f}">@${f}</option>`).join('')}
                </select>
                <button onclick="addToGroup('${groupId}')">–î–æ–±–∞–≤–∏—Ç—å</button>
            `;
            
            modal.style.display = 'flex';
        }

        function removeFromGroup(groupId, username) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å @${username} –∏–∑ –≥—Ä—É–ø–ø—ã?`)) {
                socket.emit('remove_from_group', { group_id: groupId, username: username });
            }
        }

        function addToGroup(groupId) {
            const select = document.getElementById('add-member-select');
            const userToAdd = select.value;
            if (userToAdd) {
                socket.emit('add_to_group', { group_id: groupId, username: userToAdd });
            }
        }

        function deleteGroup(groupId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                socket.emit('delete_group', { group_id: groupId });
            }
        }

        function closeGroupModal() {
            document.getElementById('group-modal').style.display = 'none';
        }

        socket.on('group_member_added', (data) => {
            if (data.username === username) {
                addSystemMessage(`‚úÖ –í–∞—Å –¥–æ–±–∞–≤–∏–ª–∏ –≤ –≥—Ä—É–ø–ø—É`);
            }
            socket.emit('get_groups');
            closeGroupModal();
        });

        socket.on('group_member_removed', (data) => {
            if (data.username === username) {
                addSystemMessage(`‚ùå –í–∞—Å —É–¥–∞–ª–∏–ª–∏ –∏–∑ –≥—Ä—É–ø–ø—ã`);
            }
            socket.emit('get_groups');
        });

        socket.on('group_updated', (data) => {
            socket.emit('get_groups');
            addSystemMessage(`‚úÖ –ì—Ä—É–ø–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞`);
        });

        socket.on('group_deleted', (data) => {
            if (currentRoom === data.group_id) {
                joinGlobalChat();
            }
            socket.emit('get_groups');
            addSystemMessage(`‚ùå –ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞`);
        });



        // ============ –ë–õ–û–ö–ò–†–û–í–ö–ê ============
        function blockUser(username) {
            if (confirm(`–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å @${username}?`)) {
                socket.emit('block_user', { username });
            }
        }

        function unblockUser(username) {
            socket.emit('unblock_user', { username });
        }

        socket.on('user_blocked', (data) => {
            blockedUsers.push(data.username);
            addSystemMessage(`üö´ @${data.username} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`);
        });

        socket.on('user_unblocked', (data) => {
            blockedUsers = blockedUsers.filter(u => u !== data.username);
            addSystemMessage(`‚úÖ @${data.username} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`);
        });

        // ============ –ë–ê–ù ============
        function banUser(username) {
            const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞:', '–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª');
            if (reason) {
                socket.emit('ban_user', { username, reason });
            }
        }

        socket.on('user_banned', (data) => {
            addSystemMessage(`üî® @${data.username} –∑–∞–±–∞–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º`);
        });

        socket.on('ban_error', (data) => {
            alert(data.msg);
        });

        // ============ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–ù–¢–ê–ö–¢–û–í ============
        function updateContactsList() {
            const pendingDiv = document.getElementById('pending-requests');
            pendingDiv.innerHTML = '';
            
            pendingRequests.forEach(user => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.innerHTML = `
                    <span class="contact-avatar">üë§</span>
                    <div class="contact-info">
                        <div class="contact-name">@${user}</div>
                    </div>
                    <button class="friend-action-btn accept-btn" onclick="acceptRequest('${user}')">‚úÖ</button>
                    <button class="friend-action-btn reject-btn" onclick="rejectRequest('${user}')">‚ùå</button>
                `;
                pendingDiv.appendChild(div);
            });
            
            const contactsDiv = document.getElementById('contacts-list');
            contactsDiv.innerHTML = '';
            
            friends.forEach(user => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.onclick = () => openPrivateChat(user);
                div.innerHTML = `
                    <span class="contact-avatar">üë§</span>
                    <div class="contact-info">
                        <div class="contact-name">@${user}</div>
                    </div>
                `;
                contactsDiv.appendChild(div);
            });
        }

        function showAvatarMenu() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå –§–∞–π–ª –±–æ–ª—å—à–µ 5MB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    socket.emit('update_profile', { avatar: event.target.result });
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // ============ –ú–ï–ù–Æ –°–û–û–ë–©–ï–ù–ò–Ø ============
        document.addEventListener('click', (e) => {
            if (e.target.closest('.message')) {
                const messageDiv = e.target.closest('.message');
                const messageId = messageDiv.dataset.id;
                const messageText = messageDiv.querySelector('.message-text')?.textContent || '';
                const messageTime = messageDiv.dataset.time;
                const isOwn = messageDiv.classList.contains('own');
                
                showMessageMenu(e, messageId, messageText, messageTime, isOwn);
            }
        });

        function showMessageMenu(e, id, text, time, isOwn) {
            e.preventDefault();
            e.stopPropagation();
            selectedMessageId = id;
            selectedMessageText = text;
            selectedMessageTime = time;
            
            const menu = document.getElementById('message-menu');
            menu.style.display = 'block';
            menu.style.left = (e.pageX - 100) + 'px';
            menu.style.top = e.pageY + 'px';
            
            document.getElementById('edit-message-btn').style.display = isOwn ? 'block' : 'none';
        }

        function hideMessageMenu() {
            document.getElementById('message-menu').style.display = 'none';
        }

        function copyMessage() {
            navigator.clipboard.writeText(selectedMessageText);
            addSystemMessage('üìã –°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ');
            hideMessageMenu();
        }

        function editMessage() {
            const newText = prompt('–ò–∑–º–µ–Ω–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (5 –º–∏–Ω—É—Ç):', selectedMessageText);
            if (newText && newText !== selectedMessageText) {
                socket.emit('edit_message', {
                    id: selectedMessageId,
                    new_text: newText,
                    room: currentRoom
                });
            }
            hideMessageMenu();
        }

        // ============ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ============
        socket.on('message_edited', (data) => {
            const messages = document.getElementById('messages').children;
            for (let msg of messages) {
                if (msg.dataset.id == data.id) {
                    const textDiv = msg.querySelector('.message-text');
                    if (textDiv) {
                        textDiv.textContent = data.new_text;
                    }
                    if (!msg.querySelector('.message-edited')) {
                        const timeSpan = msg.querySelector('.message-time');
                        const editedSpan = document.createElement('span');
                        editedSpan.className = 'message-edited';
                        editedSpan.textContent = '–∏–∑–º–µ–Ω–µ–Ω–æ';
                        timeSpan.parentNode.insertBefore(editedSpan, timeSpan.nextSibling);
                    }
                    break;
                }
            }
        });

        // ============ –§–ê–ô–õ–´ ============
        function showAttachMenu() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*,audio/*,.pdf,.doc,.docx,.txt';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file.size > 50 * 1024 * 1024) {
                    alert('‚ùå –§–∞–π–ª –±–æ–ª—å—à–µ 50MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    fileToSend = {
                        name: file.name,
                        type: file.type,
                        data: event.target.result
                    };
                    
                    const preview = document.getElementById('file-preview');
                    const previewContent = document.getElementById('file-preview-content');
                    
                    if (file.type.startsWith('image/')) {
                        previewContent.innerHTML = `<img src="${event.target.result}" style="max-width: 60px; max-height: 60px; border-radius: 8px;"> ${file.name}`;
                    } else {
                        previewContent.textContent = `üìé ${file.name}`;
                    }
                    preview.style.display = 'flex';
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        function clearFilePreview() {
            fileToSend = null;
            document.getElementById('file-preview').style.display = 'none';
        }

        // ============ –°–û–û–ë–©–ï–ù–ò–Ø ============
        socket.on('message', (data) => displayMessage(data));

        socket.on('history', (messages) => {
            document.getElementById('messages').innerHTML = '';
            messages.forEach(msg => displayMessage(msg));
        });

        function displayMessage(data) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message' + (data.username === username ? ' own' : '');
            messageDiv.dataset.id = data.id;
            messageDiv.dataset.time = data.time;
            
            const time = data.time || new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let content = '';
            let mediaHtml = '';
            
            if (data.msg && (data.msg.startsWith('data:image') || data.msg.startsWith('data:video') || 
                data.msg.startsWith('data:audio') || data.msg.startsWith('data:application'))) {
                
                if (data.msg.startsWith('data:image')) {
                    mediaHtml = `<img src="${data.msg}" class="message-media" onclick="window.open(this.src)">`;
                    content = `<div class="message-text" style="display: none;">üì∑ –§–æ—Ç–æ</div>${mediaHtml}`;
                } else if (data.msg.startsWith('data:video')) {
                    mediaHtml = `<video src="${data.msg}" controls class="message-media"></video>`;
                    content = `<div class="message-text" style="display: none;">üé• –í–∏–¥–µ–æ</div>${mediaHtml}`;
                } else if (data.msg.startsWith('data:audio')) {
                    mediaHtml = `<audio src="${data.msg}" controls style="width: 200px;"></audio>`;
                    content = `<div class="message-text" style="display: none;">üéµ –ê—É–¥–∏–æ</div>${mediaHtml}`;
                } else {
                    mediaHtml = `<a href="${data.msg}" download style="color: white; text-decoration: underline;">üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</a>`;
                    content = `<div class="message-text" style="display: none;">üìé –§–∞–π–ª</div>${mediaHtml}`;
                }
            } else {
                content = `<div class="message-text">${data.msg || ''}</div>`;
            }
            
            let header = `
                <div class="message-header">
                    <span class="message-displayname" onclick="openPrivateChat('${data.username}')">${data.display_name || data.username}</span>
                    <span class="message-username">@${data.username}</span>
                    <span class="message-time">${time}</span>
                    ${data.edited ? '<span class="message-edited">–∏–∑–º–µ–Ω–µ–Ω–æ</span>' : ''}
                </div>
            `;
            
            messageDiv.innerHTML = header + content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text) {
            const messagesDiv = document.getElementById('messages');
            const systemDiv = document.createElement('div');
            systemDiv.className = 'system-message';
            systemDiv.innerHTML = `üîµ ${text}`;
            messagesDiv.appendChild(systemDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            let msg = input.value.trim();
            
            if (fileToSend) {
                msg = fileToSend.data;
                clearFilePreview();
            }
            
            if (msg) {
                socket.emit('message', { msg, room: currentRoom });
                input.value = '';
            }
        }

        // ============ –ü–û–ò–°–ö –ü–û –°–û–û–ë–©–ï–ù–ò–Ø–ú ============
        function showSearchMessages() {
            const searchDiv = document.getElementById('search-messages');
            searchDiv.style.display = searchDiv.style.display === 'none' ? 'block' : 'none';
            if (searchDiv.style.display === 'block') {
                document.getElementById('message-search-input').focus();
            }
        }

        document.getElementById('message-search-input').addEventListener('input', (e) => {
            const query = e.target.value.trim();
            if (query.length > 2) {
                socket.emit('search_messages', {
                    query,
                    chat_type: currentChatType,
                    chat_id: currentRoom
                });
            }
        });

        socket.on('search_results_messages', (data) => {
            const resultsDiv = document.getElementById('message-search-results');
            resultsDiv.innerHTML = '';
            data.results.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.innerHTML = `<strong>${msg.display_name}:</strong> ${msg.msg.substring(0, 50)}...`;
                resultsDiv.appendChild(div);
            });
        });

        // ============ –û–ß–ò–°–¢–ö–ê –ß–ê–¢–ê ============
        function clearCurrentChat() {
            if (currentChatType === 'private' && confirm('–û—á–∏—Å—Ç–∏—Ç—å –ª–∏—á–Ω—ã–π —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —Ç—Ä–µ–±—É–µ—Ç —Å–æ–≥–ª–∞—Å–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.')) {
                socket.emit('request_clear_chat', { with_user: currentPrivateUser });
            }
        }

        socket.on('clear_chat_requested', (data) => {
            if (confirm(`@${data.from} –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç. –°–æ–≥–ª–∞—Å–∏—Ç—å—Å—è?`)) {
                socket.emit('request_clear_chat', { with_user: data.from });
            }
        });

        socket.on('chat_cleared', () => {
            document.getElementById('messages').innerHTML = '';
            addSystemMessage('üí¨ –ß–∞—Ç –æ—á–∏—â–µ–Ω');
        });

        // ============ –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ï–ù–Æ ============
        function toggleMenu() {
            const leftPanel = document.getElementById('left-panel');
            leftPanel.classList.toggle('open');
        }

        function closeMobileMenu() {
            document.getElementById('left-panel').classList.remove('open');
        }

        // ============ –ó–ê–ö–†–´–¢–ò–ï –ü–û–ü–ê–ü–û–í ============
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                document.getElementById('search-results').style.display = 'none';
            }
            if (!e.target.closest('.search-messages') && !e.target.closest('.chat-action-btn')) {
                document.getElementById('search-messages').style.display = 'none';
            }
            if (!e.target.closest('.message-menu') && !e.target.closest('.message')) {
                hideMessageMenu();
            }
        });

        // ============ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–õ–ê–í–ò–® ============
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        document.getElementById('reg-password2').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') register();
        });

        // ============ –ó–ê–ö–†–´–¢–ò–ï –ú–ï–ù–Æ –ü–†–ò –°–í–ê–ô–ü–ï ============
        if (window.innerWidth <= 768) {
            let touchStartX = 0;
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
            });
            
            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const diffX = touchEndX - touchStartX;
                const leftPanel = document.getElementById('left-panel');
                
                if (diffX < -50 && leftPanel.classList.contains('open')) {
                    closeMobileMenu();
                }
            });
        }
        // ============ –ú–ï–ù–Æ –°–û–û–ë–©–ï–ù–ò–Ø (–û–ë–ù–û–í–õ–ï–ù–ù–û–ï) ============
        document.addEventListener('click', (e) => {
            if (e.target.closest('.message')) {
                const messageDiv = e.target.closest('.message');
                const messageId = messageDiv.dataset.id;
                const messageText = messageDiv.querySelector('.message-text')?.textContent || '';
                const messageTime = messageDiv.dataset.time;
                const isOwn = messageDiv.classList.contains('own');
                const isAdmin = username === 'SENATOR';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Ñ–∞–π–ª
                const hasFile = messageDiv.querySelector('img, video, audio, a[download]') !== null;
                
                showMessageMenu(e, messageId, messageText, messageTime, isOwn, isAdmin, hasFile);
            }
        });

        function showMessageMenu(e, id, text, time, isOwn, isAdmin, hasFile) {
            e.preventDefault();
            e.stopPropagation();
            selectedMessageId = id;
            selectedMessageText = text;
            selectedMessageTime = time;
            
            const menu = document.getElementById('message-menu');
            menu.innerHTML = ''; // –û—á–∏—â–∞–µ–º –º–µ–Ω—é
            
            // –ö–Ω–æ–ø–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è —Ç–µ–∫—Å—Ç–∞)
            if (!hasFile) {
                const copyItem = document.createElement('div');
                copyItem.className = 'message-menu-item';
                copyItem.onclick = () => copyMessage();
                copyItem.innerHTML = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                menu.appendChild(copyItem);
            }
            
            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–ª—è —Ñ–∞–π–ª–æ–≤)
            if (hasFile) {
                const saveItem = document.createElement('div');
                saveItem.className = 'message-menu-item';
                saveItem.onclick = () => saveFile();
                saveItem.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                menu.appendChild(saveItem);
            }
            
            // –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤, –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç)
            if (isOwn && !hasFile) {
                const messageTime = new Date(time).getTime();
                const now = new Date().getTime();
                if (now - messageTime < 5 * 60 * 1000) {
                    const editItem = document.createElement('div');
                    editItem.className = 'message-menu-item';
                    editItem.onclick = () => editMessage();
                    editItem.innerHTML = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å';
                    menu.appendChild(editItem);
                }
            }
            
            // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
            if (isAdmin || isOwn) {
                const deleteItem = document.createElement('div');
                deleteItem.className = 'message-menu-item';
                deleteItem.onclick = () => deleteMessage();
                deleteItem.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
                menu.appendChild(deleteItem);
            }
            
            menu.style.display = 'block';
            menu.style.left = (e.pageX - 100) + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function saveFile() {
            // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–∞–π–ª–æ–º
            const messages = document.getElementById('messages').children;
            for (let msg of messages) {
                if (msg.dataset.id == selectedMessageId) {
                    const img = msg.querySelector('img');
                    const video = msg.querySelector('video');
                    const audio = msg.querySelector('audio');
                    const link = msg.querySelector('a[download]');
                    
                    if (img) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        const a = document.createElement('a');
                        a.href = img.src;
                        a.download = 'image.jpg';
                        a.click();
                    } else if (video) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∏–¥–µ–æ
                        const a = document.createElement('a');
                        a.href = video.src;
                        a.download = 'video.mp4';
                        a.click();
                    } else if (audio) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—É–¥–∏–æ
                        const a = document.createElement('a');
                        a.href = audio.src;
                        a.download = 'audio.mp3';
                        a.click();
                    } else if (link) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª –ø–æ —Å—Å—ã–ª–∫–µ
                        const a = document.createElement('a');
                        a.href = link.href;
                        a.download = link.textContent.replace('üìé ', '');
                        a.click();
                    }
                    break;
                }
            }
            hideMessageMenu();
        }

        function deleteMessage() {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                socket.emit('delete_message', {
                    id: selectedMessageId,
                    room: currentRoom
                });
            }
            hideMessageMenu();
        }

        socket.on('message_deleted', (data) => {
            const messages = document.getElementById('messages').children;
            for (let msg of messages) {
                if (msg.dataset.id == data.id) {
                    msg.remove();
                    break;
                }
            }
        });
    </script>
</body>
</html>
